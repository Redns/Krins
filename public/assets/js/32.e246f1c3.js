(window.webpackJsonp=window.webpackJsonp||[]).push([[32],{572:function(s,n,a){"use strict";a.r(n);var t=a(12),e=Object(t.a)({},(function(){var s=this,n=s.$createElement,a=s._self._c||n;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"dbcontext"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#dbcontext"}},[s._v("#")]),s._v(" DbContext")]),s._v(" "),a("h2",{attrs:{id:"_1-简介"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_1-简介"}},[s._v("#")]),s._v(" 1 简介")]),s._v(" "),a("p",[a("a",{attrs:{href:"https://docs.microsoft.com/en-us/dotnet/api/microsoft.entityframeworkcore.dbcontext?view=efcore-6.0",target:"_blank",rel:"noopener noreferrer"}},[s._v("DbContext"),a("OutboundLink")],1),s._v(" 可用于简化程序与数据库的交互，可通过"),a("code",[s._v("Nuget")]),s._v("搜索"),a("code",[s._v("[Microsoft.EntityFrameworkCore]")]),s._v("下载使用。"),a("code",[s._v("DbContext")]),s._v("相当于数据库实例，"),a("code",[s._v("DbSet")]),s._v("相当于数据库中的表。实际应用中，用户应继承"),a("code",[s._v("DbContext类")]),s._v("实现自己的子类，在子类中为每个数据实体添加"),a("code",[s._v("DbSet")]),s._v("属性。若这些属性的"),a("code",[s._v("Setter")]),s._v("权限为"),a("code",[s._v("public")]),s._v("，那么当"),a("code",[s._v("DbContext")]),s._v("实例被创建时，这些属性均会被初始化。")]),s._v(" "),a("h2",{attrs:{id:"_2-创建数据库上下文"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_2-创建数据库上下文"}},[s._v("#")]),s._v(" 2 创建数据库上下文")]),s._v(" "),a("ol",[a("li",[a("p",[s._v("在工程目录下创建"),a("code",[s._v("Model")]),s._v("文件夹，用于存放数据实体和数据库上下文")])]),s._v(" "),a("li",[a("p",[s._v("选中"),a("code",[s._v("Model")]),s._v("文件夹，右键添加 ----\x3e 类（建议类名以"),a("code",[s._v("DbContext")]),s._v("结尾）")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://xg3.jiashumao.net/2022/03/05/wWIr5HYg.png",alt:"image-20220305002112066"}})])]),s._v(" "),a("li",[a("p",[s._v("添加构造函数，根据实际情况添加"),a("code",[s._v("DbSet")]),s._v("属性")]),s._v(" "),a("p",[a("img",{attrs:{src:"https://xg3.jiashumao.net/2022/03/05/SCe2v9IZ.png",alt:"image-20220305002306473"}})])])]),s._v(" "),a("p",[s._v("​\t\t以上图为例，该上下文包含一个"),a("code",[s._v("DbSet<User>")]),s._v("类型的属性且属性名为"),a("code",[s._v("Users")]),s._v("，则 EF 框架将默认在数据库中查找 "),a("code",[s._v("Users")]),s._v(" 表。")]),s._v(" "),a("ol",{attrs:{start:"4"}},[a("li",[a("p",[s._v("重写"),a("code",[s._v("OnConfiguring")]),s._v("方法，连接数据库（以SQL Server为例）")]),s._v(" "),a("div",{staticClass:"language-c# line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('// TrustServerCertificate属性为True表示让SQL Server信任HTTPS连接\nstring connectStr = "Data Source=[server_instance];Initial Catalog=[database_name];User ID=[username];Pwd=[password];TrustServerCertificate=true";\nprotected override void OnConfiguring(DbContextOptionsBuilder opt)\n{\n    opt.UseSqlServer(connectStr);\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br")])])]),s._v(" "),a("li",[a("p",[s._v("在"),a("code",[s._v("Program.cs")]),s._v("文件中注册"),a("code",[s._v("DbContext")]),s._v("服务")]),s._v(" "),a("div",{staticClass:"language-c# line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("/// <summary>\n/// 向容器中注入服务\n/// </summary>\nbuilder.Services.AddControllers();\nbuilder.Services.AddDbContext<OurDbContext>();\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br")])])])]),s._v(" "),a("h2",{attrs:{id:"_3-数据库操作"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-数据库操作"}},[s._v("#")]),s._v(" 3 数据库操作")]),s._v(" "),a("p",[s._v("在上一步中我们知道了如何使用"),a("code",[s._v("DbContext")]),s._v("连接数据库，下面介绍如何对数据库中的表进行增、删、查、改操作。由于一个数据库中通常包含若干个表，每个表对应着一个数据实体，每个实体的操作往往是不同的。因此，我建议在"),a("code",[s._v("DbContext")]),s._v("子类的命名空间中，分别为每个实体创建类，以用于数据库操作。")]),s._v(" "),a("div",{staticClass:"language-c# line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("namespace Model\n{\n\tpublic class OurDbContext : DbContext\n    {\n        // ...\n    \n        // 映射数据库中的表\n        public DbSet<UserEntity>? Users { get; set; }               // 用户表\n        public DbSet<AccessEntity>? Accesses { get; set; }          // 出入登记表\n    }\n\n\n    /// <summary>\n    /// 用户表相关操作\n    /// </summary>\n    public class SQLUserData\n    {\n    }\n    \n    \n    /// <summary>\n    /// 出入登记表相关操作\n    /// </summary>\n    public class SQLAccessData\n    {\n    }\n}\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br")])]),a("h3",{attrs:{id:"_3-1-初始化"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-1-初始化"}},[s._v("#")]),s._v(" 3.1 初始化")]),s._v(" "),a("p",[s._v("想要操作数据库中的表，需要分两步完成：")]),s._v(" "),a("ol",[a("li",[s._v("获取数据库实例")]),s._v(" "),a("li",[s._v("获取数据库中表的实例")])]),s._v(" "),a("p",[s._v("下面以"),a("code",[s._v("Users")]),s._v("表为例，演示如何获取数据库中表的实例")]),s._v(" "),a("div",{staticClass:"language-c# line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v("/// <summary>\n/// 用户表相关操作\n/// </summary>\npublic class SQLUserData\n{\n    // OutDbContext为之前创建的数据库上下文\n    private OurDbContext? _context { get; set; }\n    public SQLUserData(OurDbContext context)\n    {\n        _context = context;\n    } \n}\n\n\npublic class Test\n{\n\tpublic void InitSQLUserData()\n    {\n        // 使用using后，系统会在合适的时机释放连接资源\n    \tusing var context = new OurDbContext();   \n        SQLUserData sqlUserData = new SQLUserData(context);\n        \n        // 增、删、查、改\n        // ...\n    }    \n}\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br")])]),a("h3",{attrs:{id:"_3-2-增删查改"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_3-2-增删查改"}},[s._v("#")]),s._v(" 3.2 增删查改")]),s._v(" "),a("p",[s._v("下面以"),a("code",[s._v("Users")]),s._v("表为例，演示如何执行增删查改操作")]),s._v(" "),a("div",{staticClass:"language-c# line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[s._v('/// <summary>\n/// 用户表相关操作\n/// </summary>\npublic class SQLUserData\n{\n    // OutDbContext为之前创建的数据库上下文\n    private OurDbContext? _context { get; set; }\n    public SQLUserData(OurDbContext context)\n    {\n        _context = context;\n    } \n    \n    /// <summary>\n    /// 添加用户\n    /// </summary>\n    /// <param name="user"></param>\n    public void Add(UserEntity user)\n    {\n        // 添加完成后务必要保存\n        _context?.Add(user);\n        _context?.SaveChanges();\n    }\n\n\n    /// <summary>\n    /// 获取用户列表\n    /// </summary>\n    /// <returns></returns>\n    public IEnumerable<UserEntity>? Get()\n    {\n        return _context?.Users?.ToList();\n    }\n\n\n    /// <summary>\n    /// 根据ID获取用户\n    /// </summary>\n    /// <param name="id"></param>\n    /// <returns></returns>\n    public UserEntity? Get(string id)\n    {\n        return _context?.Users?.FirstOrDefault(u => u.Id == id);\n    }\n}\n')])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br")])]),a("h2",{attrs:{id:"_4-注意"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-注意"}},[s._v("#")]),s._v(" 4 注意")]),s._v(" "),a("h3",{attrs:{id:"_4-1-并行执行"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#_4-1-并行执行"}},[s._v("#")]),s._v(" 4.1 并行执行")]),s._v(" "),a("p",[a("code",[s._v("Entity Framework Core")]),s._v("对于同一个"),a("code",[s._v("DbContext实例")]),s._v("不支持并行执行，例如")]),s._v(" "),a("ul",[a("li",[s._v("异步查询的并行调用")]),s._v(" "),a("li",[s._v("不同线程对"),a("code",[s._v("DbContext实例")]),s._v("的明确并行调用")])]),s._v(" "),a("p",[s._v("可通过下列方法避免问题")]),s._v(" "),a("ul",[a("li",[s._v("执行"),a("code",[s._v("async")]),s._v("调用时，立即使用"),a("code",[s._v("await")])]),s._v(" "),a("li",[s._v("每次操作均使用不同的"),a("code",[s._v("DbContext实例")])])])])}),[],!1,null,null,null);n.default=e.exports}}]);